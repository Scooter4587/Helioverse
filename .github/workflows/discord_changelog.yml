name: Push changelog to Discord

on:
  push:
    branches: [ "main" ]
    paths:
      - "CHANGELOG.md"
      - ".github/workflows/discord_changelog.yml"

jobs:
  send-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract latest block (Helioverse format)
        id: extract
        shell: bash
        run: |
          set -euo pipefail
          # Najnov≈°√≠ blok zaƒç√≠na riadkom: [X.Y.Z] ‚Äì YYYY-MM-DD  (alebo s '-')
          awk '
            BEGIN{in_section=0}
            /^\[[0-9]+\.[0-9]+\.[0-9]+\][[:space:]]*[‚Äì-][[:space:]]*[0-9]{4}-[0-9]{2}-[0-9]{2}[[:space:]]*$/ {
              if(in_section==0){in_section=1; print; next} else {exit}
            }
            { if(in_section==1){print} }
          ' CHANGELOG.md > latest.txt

          if ! [ -s latest.txt ]; then
            echo "ERROR: Nen√°jden√Ω ≈æiadny blok verzie vo form√°te: [X.Y.Z] ‚Äì YYYY-MM-DD" >&2
            echo "Obsah CHANGELOG.md:" >&2
            nl -ba CHANGELOG.md >&2 || true
            exit 1
          fi

          echo "---- Latest block ----"
          cat latest.txt
          echo "----------------------"

          # Po≈°li latest ako multi-line output
          {
            echo "latest<<EOF"
            cat latest.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post to Discord (plain content, AstroMiner-style)
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          LATEST: ${{ steps.extract.outputs.latest }}
        shell: bash
        run: |
          set -euo pipefail
          # Zlo≈æenie spr√°vy (zachov√°me nov√© riadky)
          CONTENT=$(printf "üõ†Ô∏è **Helioverse ‚Äì nov√Ω update!**\n\n%s" "$LATEST")

          # JSON payload
          PAYLOAD=$(jq -n --arg content "$CONTENT" '{content: $content}')

          # Po≈°li na Discord + vyp√≠≈° HTTP k√≥d
          RESP="$(curl -sS -w '\n%{http_code}' \
                 -H 'Content-Type: application/json' \
                 -X POST \
                 -d "$PAYLOAD" \
                 "$WEBHOOK_URL")"
          HTTP_CODE="$(printf '%s' "$RESP" | tail -n1)"
          echo "Discord HTTP code: $HTTP_CODE"
          test "$HTTP_CODE" = "204" -o "$HTTP_CODE" = "200"